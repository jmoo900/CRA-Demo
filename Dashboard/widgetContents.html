import { LitElement, html, css } from 'lit';
import { styleImports } from 'styles';
import * as echarts from 'echarts';

export default class FirmwareSecurityWidget extends LitElement {
  static styles = css`
    :host > div {
      padding-left: var(--c8y-root-component-padding);
      padding-right: var(--c8y-root-component-padding);
    }
    
    .chart-container {
      width: 100%;
      height: 350px;
      margin-top: 10px;
    }
    
    .charts-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .chart-wrapper {
      flex: 1;
      min-width: 0;
    }
    
    .chart-title {
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      color: var(--c8y-text-color);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 400px;
      font-size: 16px;
      color: var(--c8y-text-color);
    }
    
    .error {
      color: var(--c8y-danger);
      text-align: center;
      padding: 20px;
    }
    
    .stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
      padding: 15px;
      background-color: var(--c8y-background-color-light);
      border-radius: 4px;
    }
    
    .stat-item {
      text-align: center;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: var(--c8y-brand-primary);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--c8y-text-color-secondary);
      text-transform: uppercase;
    }
    
    .security-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .badge-critical { background-color: #dc3545; color: white; }
    .badge-high { background-color: #fd7e14; color: white; }
    .badge-medium { background-color: #ffc107; color: black; }
    .badge-marginal { background-color: #ffc107; color: black; }
    .badge-low { background-color: #28a745; color: white; }
    .badge-none { background-color: #6c757d; color: white; }
    .badge-unknown { background-color: #adb5bd; color: white; }
    
    ul.device-list {
      margin: 5px 0 15px 20px;
      padding: 0;
    }
    ul.device-list li {
      list-style: disc;
      margin-bottom: 2px;
    }
    ul.device-list li a {
      color: var(--c8y-link-color, #007bff);
      text-decoration: none;
    }
    ul.device-list li a:hover {
      text-decoration: underline;
    }
    
    @media (max-width: 768px) {
      .charts-row {
        flex-direction: column;
      }
    }
  `;

  static properties = {
    c8yContext: { type: Object },
    firmwareData: { type: Array },
    securityData: { type: Array },
    combinedData: { type: Array },
    devicesByRisk: { type: Object },
    loading: { type: Boolean },
    error: { type: String }
  };

  constructor() {
    super();
    this.firmwareData = [];
    this.securityData = [];
    this.combinedData = [];
    this.devicesByRisk = {};
    this.loading = true;
    this.error = null;
    this.firmwareChart = null;
    this.securityChart = null;
  }

  async connectedCallback() {
    super.connectedCallback();
    await this.loadFirmwareData();
  }

  async loadFirmwareData() {
    try {
      this.loading = true;
      this.error = null;

      // First, get all firmware binaries to build version -> risk mapping
      const binariesResponse = await fetch('/inventory/managedObjects?type=c8y_FirmwareBinary&pageSize=100');
      const binariesData = await binariesResponse.json();

      const versionToSecurityRisk = {};
      binariesData.managedObjects.forEach(binary => {
        if (binary.c8y_Firmware && binary.c8y_Firmware.version) {
          const version = binary.c8y_Firmware.version;
          const securityRisk = binary.securityRisk || 'unknown';
          versionToSecurityRisk[version] = securityRisk;
        }
      });

      // Now get all devices with firmware
      const devicesResponse = await fetch('/inventory/managedObjects?fragmentType=c8y_IsDevice&fragmentType=c8y_Firmware&pageSize=2000');
      const devicesData = await devicesResponse.json();

      const versionCounts = {};
      const securityCounts = {};
      let totalDevices = 0;

      // Init devicesByRisk grouping
      this.devicesByRisk = {
        critical: [],
        high: [],
        medium: [],
        marginal: [],
        low: [],
        none: [],
        unknown: []
      };

      devicesData.managedObjects.forEach(device => {
        if (device.c8y_Firmware && device.c8y_Firmware.version) {
          const version = device.c8y_Firmware.version;
          const securityRisk = versionToSecurityRisk[version] || 'unknown';

          // Count versions
          versionCounts[version] = (versionCounts[version] || 0) + 1;

          // Count security risks
          securityCounts[securityRisk] = (securityCounts[securityRisk] || 0) + 1;

          // Group devices by risk
          this.devicesByRisk[securityRisk].push({
            id: device.id,
            name: device.name || 'Unnamed Device',
            version,
            risk: securityRisk
          });

          totalDevices++;
        }
      });

      // Convert to array for the charts
      this.firmwareData = Object.entries(versionCounts)
        .map(([version, count]) => ({
          name: version,
          value: count,
          percentage: ((count / totalDevices) * 100).toFixed(1)
        }))
        .sort((a, b) => b.value - a.value);

      this.securityData = Object.entries(securityCounts)
        .map(([risk, count]) => ({
          name: risk,
          value: count,
          percentage: ((count / totalDevices) * 100).toFixed(1)
        }))
        .sort((a, b) => b.value - a.value);

      // Combined data table
      this.combinedData = Object.entries(versionCounts)
        .map(([version, count]) => ({
          version: version,
          securityRisk: versionToSecurityRisk[version] || 'unknown',
          deviceCount: count,
          percentage: ((count / totalDevices) * 100).toFixed(1)
        }))
        .sort((a, b) => b.deviceCount - a.deviceCount);

      this.totalDevices = totalDevices;
      this.uniqueVersions = Object.keys(versionCounts).length;
      this.totalBinaries = binariesData.managedObjects.length;
      this.criticalRiskDevices = securityCounts['critical'] || 0;

      this.loading = false;
      this.requestUpdate();

      setTimeout(() => {
        this.initFirmwareChart();
        this.initSecurityChart();
      }, 100);

    } catch (error) {
      console.error('Error loading firmware data:', error);
      this.error = 'Failed to load firmware data';
      this.loading = false;
    }
  }

  getRiskOrder() {
    return ['critical', 'high', 'medium', 'marginal', 'low', 'none', 'unknown'];
  }

  initFirmwareChart() {
    const chartElement = this.shadowRoot.querySelector('#firmwareChart');
    if (!chartElement || this.firmwareData.length === 0) return;
    if (this.firmwareChart) this.firmwareChart.dispose();
    this.firmwareChart = echarts.init(chartElement);

    const option = {
      tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} devices ({d}%)' },
      legend: { orient: 'vertical', left: 'left', textStyle: { fontSize: 11 } },
      series: [{
        name: 'Firmware Versions',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['60%', '50%'],
        avoidLabelOverlap: false,
        itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
        label: { show: false },
        emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } },
        data: this.firmwareData.map(item => ({ name: item.name, value: item.value }))
      }],
      color: ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc', '#ff9f7f']
    };
    this.firmwareChart.setOption(option);
  }

  initSecurityChart() {
    const chartElement = this.shadowRoot.querySelector('#securityChart');
    if (!chartElement || this.securityData.length === 0) return;
    if (this.securityChart) this.securityChart.dispose();
    this.securityChart = echarts.init(chartElement);

    const securityColors = {
      'critical': '#dc3545', 'high': '#fd7e14', 'medium': '#ffc107', 'marginal': '#ffc107',
      'low': '#28a745', 'none': '#6c757d', 'unknown': '#adb5bd'
    };

    const option = {
      tooltip: { trigger: 'item', formatter: '{a} <br/>{b}: {c} devices ({d}%)' },
      legend: { orient: 'vertical', left: 'left', textStyle: { fontSize: 11 } },
      series: [{
        name: 'Security Risk',
        type: 'pie',
        radius: ['40%', '70%'],
        center: ['60%', '50%'],
        avoidLabelOverlap: false,
        itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
        label: { show: false },
        emphasis: { label: { show: true, fontSize: '14', fontWeight: 'bold' } },
        data: this.securityData.map(item => ({
          name: item.name,
          value: item.value,
          itemStyle: { color: securityColors[item.name] || '#adb5bd' }
        }))
      }]
    };
    this.securityChart.setOption(option);
  }

  getSecurityBadgeClass(risk) {
    switch (risk) {
      case 'critical': return 'badge-critical';
      case 'high': return 'badge-high';
      case 'medium': return 'badge-medium';
      case 'marginal': return 'badge-marginal';
      case 'low': return 'badge-low';
      case 'none': return 'badge-none';
      default: return 'badge-unknown';
    }
  }

  render() {
    return html`
      <style>${styleImports}</style>
      <div>
        ${this.loading ? html`
          <div class="loading">
            <div class="spinner-border text-primary" role="status"></div>
            <span style="margin-left: 10px;">Loading firmware data...</span>
          </div>
        ` : this.error ? html`
          <div class="error"><i class="fa fa-exclamation-triangle"></i>${this.error}</div>
        ` : html`
          <div class="stats">
            <div class="stat-item">
              <div class="stat-value">${this.totalDevices || 0}</div>
              <div class="stat-label">Total Devices</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${this.totalBinaries || 0}</div>
              <div class="stat-label">Firmware Binaries</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${this.firmwareData.length > 0 ? this.firmwareData[0].name : 'N/A'}</div>
              <div class="stat-label">Most Common</div>
            </div>
            <div class="stat-item">
              <div class="stat-value risk-critical">${this.criticalRiskDevices || 0}</div>
              <div class="stat-label">Critical Risk Devices</div>
            </div>
          </div>
          
          <div class="charts-row">
            <div class="chart-wrapper">
              <div class="chart-title">Device Distribution by Firmware Version</div>
              <div class="chart-container"><div id="firmwareChart" style="width: 100%; height: 100%;"></div></div>
            </div>
            <div class="chart-wrapper">
              <div class="chart-title">Device Distribution by Security Risk</div>
              <div class="chart-container"><div id="securityChart" style="width: 100%; height: 100%;"></div></div>
            </div>
          </div>
          
          ${this.combinedData.length > 0 ? html`
            <div class="mt-4">
              <h6>Firmware Security Analysis:</h6>
              <table class="table table-sm">
                <thead>
                  <tr><th>Firmware Version</th><th>Security Risk</th><th>Device Count</th><th>Percentage</th></tr>
                </thead>
                <tbody>
                  ${this.combinedData.map(item => html`
                    <tr>
                      <td><code>${item.version}</code></td>
                      <td><span class="security-badge ${this.getSecurityBadgeClass(item.securityRisk)}">${item.securityRisk}</span></td>
                      <td>${item.deviceCount}</td>
                      <td>${item.percentage}%</td>
                    </tr>
                  `)}
                </tbody>
              </table>
            </div>
          ` : ''}

          <div class="mt-4">
            <h6>Devices by Firmware Security Risk:</h6>
            ${this.getRiskOrder().map(risk => html`
              ${this.devicesByRisk[risk] && this.devicesByRisk[risk].length > 0 ? html`
                <div class="mb-2">
                  <div><span class="security-badge ${this.getSecurityBadgeClass(risk)}">${risk}</span> 
                  (${this.devicesByRisk[risk].length} device${this.devicesByRisk[risk].length > 1 ? 's' : ''})</div>
                  <ul class="device-list">
                    ${this.devicesByRisk[risk].map(dev => html`
                      <li>
                        <a href="/apps/devicemanagement/index.html#/device/${dev.id}" target="_blank">
                          ${dev.name}
                        </a> 
                        <small style="color: var(--c8y-text-color-secondary);">(${dev.version})</small>
                      </li>
                    `)}
                  </ul>
                </div>
              ` : ''}
            `)}
          </div>
        `}
      </div>
    `;
  }

  disconnectedCallback() {
    super.disconnectedCallback();
    if (this.firmwareChart) this.firmwareChart.dispose();
    if (this.securityChart) this.securityChart.dispose();
  }
}
